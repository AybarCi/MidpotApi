version: '3.8'

services:
  # PostgreSQL Database (COMMENTED OUT - Using external database at 172.17.0.9)
  # Uncomment if you want to run PostgreSQL locally instead of using external server
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: midpot-postgres
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_DB: ${POSTGRES_DB:-socialdb}
  #     POSTGRES_USER: ${POSTGRES_USER:-postgres}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
  #     POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #     - ./Database:/docker-entrypoint-initdb.d:ro
  #   ports:
  #     - "5432:5432"
  #   networks:
  #     - midpot-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-socialdb}"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: midpot-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - midpot-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Midpot API Application - Production
  midpot-api:
    image: ghcr.io/aybarci/midpotapi:latest
    
    container_name: midpot-api
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:80
      
      # Database Configuration
      POSTGRES_DB: socialdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: SeKo153759++
      
      # Database Connection
      ConnectionStrings__PostgreConnection: "Host=172.17.0.9;Port=5432;Database=socialdb;Username=postgres;Password=SeKo153759++;Pooling=true;MinPoolSize=10;MaxPoolSize=100;ConnectionLifetime=0;CommandTimeout=30;"
      
      # Redis Configuration
      Redis__ConnectionString: "redis:6379,abortConnect=false,connectTimeout=5000,ssl=false"
      Redis__DefaultExpiryMinutes: 60
      Redis__UserProfileExpiryMinutes: 120
      Redis__MatchResultsExpiryMinutes: 30
      Redis__LocationDataExpiryMinutes: 15
      REDIS_DEFAULT_EXPIRY: 60
      REDIS_USER_PROFILE_EXPIRY: 120
      REDIS_MATCH_EXPIRY: 30
      REDIS_LOCATION_EXPIRY: 15
      
      # JWT Configuration
      JWT_KEY: change_this_to_a_very_long_random_secret_key_at_least_64_chars
      JWT_ISSUER: https://www.midpot.net
      JWT_AUDIENCE: https://www.midpot.net
      JWT_LIFETIME: 48
      JWT_REFRESH_LIFETIME: 360
      Tokens__Key: change_this_to_a_very_long_random_secret_key_at_least_64_chars
      Tokens__Issuer: https://www.midpot.net
      Tokens__Audience: https://www.midpot.net
      Tokens__Lifetime: 48
      Tokens__RefreshTokenLifetime: 360
      
      # External Services
      AzureBlobStorage: ${AZURE_BLOB_STORAGE:-}
      FCM__SenderId: ${FCM_SENDER_ID:-}
      FCM__ServerKey: ${FCM_SERVER_KEY:-}
      SMS__SmsServiceUrl: ${SMS_SERVICE_URL:-https://api.vatansms.net/api/v1/1toN}
      SMS__UserId: ${SMS_USER_ID:-}
      SMS__Password: ${SMS_PASSWORD:-}
      SMS__Sender: ${SMS_SENDER:-MidpotApp}
      
      # Security
      Security__Key: ${SECURITY_KEY}
      DistanceLimit: ${DISTANCE_LIMIT:-100}
      
      # Optional: Enable migrations on startup
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-false}
      
    ports:
      - "5000:80"
    networks:
      - midpot-network
    volumes:
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy (Optional - for production with SSL)
  nginx:
    image: nginx:alpine
    container_name: midpot-nginx
    restart: unless-stopped
    depends_on:
      - midpot-api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    networks:
      - midpot-network
    profiles:
      - with-proxy

networks:
  midpot-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
